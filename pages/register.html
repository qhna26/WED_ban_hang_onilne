<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ÄÄƒng kÃ½ | TTN Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../css/login-new.css">
</head>
<body>
  <canvas id="bg-animation"></canvas>

  <div class="ttn-logo">TTN</div>

  <div class="auth-container">
    <h2>ÄÄƒng kÃ½ tÃ i khoáº£n</h2>
    <p>Vui lÃ²ng nháº­p thÃ´ng tin cá»§a báº¡n Ä‘á»ƒ tiáº¿p tá»¥c</p>

    <form id="registerForm" autocomplete="off">
      <!-- ThÃ´ng tin cÃ¡ nhÃ¢n -->
      <label for="fullname">Há» vÃ  tÃªn</label>
      <input type="text" id="fullname" required>

      <label for="email">Email</label>
      <input type="email" id="email" required>

      <label for="password">Máº­t kháº©u</label>
      <input type="password" id="password" required>

      <label for="confirmPassword">XÃ¡c nháº­n máº­t kháº©u</label>
      <input type="password" id="confirmPassword" required>

      <div class="show-password">
        <input type="checkbox" id="togglePassword">
        <label for="togglePassword">Hiá»‡n máº­t kháº©u</label>
      </div>

      <!-- Gá»­i OTP -->
      <button type="button" id="sendOtpBtn">Gá»­i mÃ£ xÃ¡c thá»±c</button>

      <!-- Nháº­p OTP -->
      <div id="otpSection" style="display:none; margin-top:15px;">
        <label for="otpInput">Nháº­p mÃ£ OTP Ä‘Ã£ gá»­i tá»›i email</label>
        <input type="text" id="otpInput" placeholder="Nháº­p mÃ£ OTP" required>
        <button type="submit">XÃ¡c nháº­n Ä‘Äƒng kÃ½</button>
      </div>
    </form>

    <div class="auth-link">
      ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="login.html">ÄÄƒng nháº­p</a>
    </div>
    <div class="auth-link">
      <a href="forgot-password.html">QuÃªn máº­t kháº©u?</a>
    </div>

    <div id="registerMessage" class="auth-message"></div>
  </div>

  <script src="../js/login-animate.js"></script>
  <script>
    // Hiá»‡n / áº©n máº­t kháº©u
    const toggle = document.getElementById('togglePassword');
    const pass = document.getElementById('password');
    const confirmPass = document.getElementById('confirmPassword');
    toggle.addEventListener('change', () => {
      const type = toggle.checked ? 'text' : 'password';
      pass.type = type;
      confirmPass.type = type;
    });

    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpSection = document.getElementById('otpSection');
    const registerForm = document.getElementById('registerForm');
    const message = document.getElementById('registerMessage');

    // ğŸŸ¡ Gá»­i OTP
    sendOtpBtn.addEventListener('click', async () => {
      const fullname = document.getElementById('fullname').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!fullname || !email || !password || !confirmPassword) {
        showMessage('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!', 'red');
        return;
      }
      if (password !== confirmPassword) {
        showMessage('Máº­t kháº©u khÃ´ng khá»›p!', 'red');
        return;
      }

      // ğŸ”¥ Kiá»ƒm tra email Ä‘Ã£ tá»“n táº¡i chÆ°a (dá»¯ liá»‡u localStorage)
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      if (users.find(u => u.email === email)) {
        showMessage('Email nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½!', 'red');
        return;
      }

      // Gá»­i OTP qua server Node
      try {
        const res = await fetch('http://127.0.0.1:4000/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (data.status === 'ok') {
          showMessage('ÄÃ£ gá»­i mÃ£ OTP Ä‘áº¿n email cá»§a báº¡n. Kiá»ƒm tra há»™p thÆ°!', 'green');
          otpSection.style.display = 'block';

          // LÆ°u táº¡m thÃ´ng tin Ä‘á»ƒ dÃ¹ng sau khi xÃ¡c nháº­n OTP
          sessionStorage.setItem('pendingUser', JSON.stringify({ fullname, email, password }));
        } else {
          showMessage('KhÃ´ng gá»­i Ä‘Æ°á»£c mÃ£ xÃ¡c thá»±c, thá»­ láº¡i!', 'red');
        }
      } catch (error) {
        console.error(error);
        showMessage('Lá»—i káº¿t ná»‘i Ä‘áº¿n server OTP!', 'red');
      }
    });

    // ğŸŸ¢ XÃ¡c nháº­n OTP + Ä‘Äƒng kÃ½
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const otp = document.getElementById('otpInput').value.trim();
      const pendingUser = JSON.parse(sessionStorage.getItem('pendingUser') || 'null');

      if (!pendingUser) {
        showMessage('Vui lÃ²ng gá»­i mÃ£ OTP trÆ°á»›c!', 'red');
        return;
      }

      try {
        const res = await fetch('http://127.0.0.1:4000/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: pendingUser.email, otp })
        });
        const data = await res.json();

        if (data.status === 'ok') {
          // LÆ°u tÃ i khoáº£n vÃ o localStorage
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          users.push({
            fullname: pendingUser.fullname,
            email: pendingUser.email,
            password: pendingUser.password,
            role: 'CUSTOMER'
          });
          localStorage.setItem('users', JSON.stringify(users));

          sessionStorage.removeItem('pendingUser');
          showMessage('ÄÄƒng kÃ½ thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng...', 'green');

          setTimeout(() => window.location.href = 'login.html', 2000);
        } else {
          showMessage('MÃ£ OTP khÃ´ng chÃ­nh xÃ¡c hoáº·c Ä‘Ã£ háº¿t háº¡n!', 'red');
        }
      } catch (error) {
        console.error(error);
        showMessage('Lá»—i xÃ¡c thá»±c OTP!', 'red');
      }
    });

    function showMessage(text, color) {
      message.textContent = text;
      message.style.color = color;
    }
  </script>
</body>
</html>
